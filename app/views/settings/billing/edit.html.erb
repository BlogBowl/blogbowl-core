<% content_for :title, "Billing settings" %>
<div class="mx-auto w-full py-10">
  <%= link_to settings_path do %>
    <div class="flex gap-x-2 items-center text-sm opacity-70 cursor-pointer hover:opacity-50 active:opacity-40">
      <i class="iconoir-arrow-left"></i>
      <p>Back to settings</p>
    </div>
  <% end %>
  <div class="flex justify-between mb-5 mt-2">
    <div>
      <h1 class="font-bold">Billing</h1>
    </div>
  </div>

  <%= render partial: 'shared/flashes' %>

  <div class="mt-5" data-controller="billing"
       data-billing-selected-blog-price-value="<%= @selected_blog_price %>"
       data-billing-selected-newsletter-price-value="<%= @selected_newsletter_price %>"
  >

    <% if @subscription.present? %>
      <div id="current-plan-view">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-gray-200">
          <h2 class="text-base font-semibold text-gray-900 mb-4">Current Workspace Plan</h2>
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div class="flex flex-col gap-y-3">
              <div class="flex gap-x-2 items-center">
                <p class="text-gray-600 w-36">Blog Plan:</p>
                <p class="font-semibold text-gray-800" data-billing-target="selectedBlogPlan">None selected</p>
              </div>
              <div class="flex gap-x-2 items-center">
                <p class="text-gray-600 w-36">Newsletter Plan:</p>
                <p class="font-semibold text-gray-800" data-billing-target="selectedNewsletterPlan">None
                  selected</p>
              </div>
            </div>
            <div class="mt-4 sm:mt-0 text-left sm:text-right">
              <p class="text-lg font-bold text-gray-900" data-billing-target="totalPrice">$0.00/mo</p>
              <p class="text-xs text-gray-500 text-right" data-billing-target="billedInterval"></p>
              <% if @subscription.cancel_at_period_end %>
                <p class="text-gray-500 text-sm">Cancels at
                  <span class="font-medium"><%= Time.at(@subscription.current_period_end).strftime('%B %d, %Y') %></span>
                </p>
              <% else %>
                <p class="text-gray-500 text-sm">Renews on
                  <span class="font-medium"><%= Time.at(@subscription.current_period_end).strftime('%B %d, %Y') %></span>
                </p>
                <%#= button_to "Cancel Subscription", cancel_subscription_pages_settings_billing_path, method: :post, class: "text-sm text-red-600 hover:text-red-800 font-medium mt-1" %>
              <% end %>
            </div>
          </div>
          <div class="border-t border-gray-200 mt-6 pt-6 flex flex-col sm:flex-row gap-4 justify-end">
            <button type="button"
                    class="btn btn-lg btn-outline btn-neutral"
                    data-action="click->billing#showChangePlan">
              Change Plan
            </button>
          </div>
        </div>
      </div>
    <% end %>

    <div id="new-plan-view" style="display: <%= @subscription.present? ? 'none' : 'block' %>">
      <div class="flex items-center justify-center gap-x-2 mx-auto mb-10">
        <p>Monthly</p>
        <input
          type='checkbox'
          <% if @selected_interval == 'year' %>checked
          <% end %>
          <% if @has_subscription %>disabled
          <% end %>
          class="toggle toggle-primary checked:bg-primary checked:text-white checked:border-primary"
          data-billing-target="toggle"
          data-action="change->billing#togglePricing"
            />
        <div class="flex items-center">
          <p>Yearly</p>
          <div class="rounded-full px-2 py-1 bg-primary text-white ml-1">
            <p class="text-xs">-10%</p>
          </div>
        </div>
      </div>

      <!-- Main Content as a Form -->
      <%= form_with(url: checkout_settings_billing_url, method: :post, id: "billing-form", data: { turbo: false }) do |form| %>
        <div id="billing-selection">
          <!-- Monthly Plans Container -->
          <div data-billing-target="monthlyPlans">
            <!-- Blog Plans Section -->
            <div class="mb-12">
              <h2 class="text-2xl font-semibold text-gray-800 mb-1">Choose your Blog Plan</h2>
              <p class="text-gray-500 mb-6">Based on monthly page views.</p>
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                <% @blog_products.each do |product| %>
                  <div>
                    <%= form.radio_button :blog_price_id, product.monthly_plan.id, id: product.monthly_plan.id, checked: @selected_blog_price == product.monthly_plan.id, class: "hidden peer", data: { plan_price: product.monthly_plan&.unit_amount / 100, plan_name: product.metadata.name, action: "change->billing#recalculate" } %>
                    <label for="<%= product.monthly_plan.id %>" class="inline-block w-full p-6 text-gray-500 bg-white border-2 border-gray-200 rounded-lg cursor-pointer transition-all duration-200 ease-in-out hover:text-gray-600 hover:bg-gray-50 hover:shadow-md peer-checked:border-primary peer-checked:shadow-lg">
                      <span class="font-bold text-lg text-gray-800"><%= product.metadata.name %></span>
                      <span class="text-2xl font-extrabold flex items-end text-gray-900 mt-1">
                      $<%= product.monthly_plan&.unit_amount / 100 %>
                        <span class="text-base font-medium text-gray-500">/mo</span>
                    </span>
                    </label>
                  </div>
                <% end %>
              </div>
            </div>
            <!-- Newsletter Plans Section -->
            <div class="mb-12">
              <h2 class="text-2xl font-semibold text-gray-800 mb-1">Choose your Newsletter Plan</h2>
              <p class="text-gray-500 mb-6">Based on e-mails sent per month.</p>
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                <% @newsletter_products.each do |product| %>
                  <div>
                    <%= form.radio_button :newsletter_price_id, product.monthly_plan.id, id: product.monthly_plan.id, class: "hidden peer", checked: @selected_newsletter_price == product.monthly_plan.id, data: { plan_price: product.monthly_plan&.unit_amount / 100, plan_name: product.metadata.name, action: "change->billing#recalculate" } %>
                    <label for="<%= product.monthly_plan.id %>" class="inline-block w-full p-6 text-gray-500 bg-white border-2 border-gray-200 rounded-lg cursor-pointer transition-all duration-200 ease-in-out hover:text-gray-600 hover:bg-gray-50 hover:shadow-md peer-checked:border-primary peer-checked:shadow-lg">
                      <span class="font-bold text-lg text-gray-800"><%= product.metadata.name %></span>
                      <span class="text-2xl font-extrabold flex items-end text-gray-900 mt-1">
                      $<%= product.monthly_plan&.unit_amount / 100 %>
                        <span class="text-base font-medium text-gray-500">/mo</span>
                    </span>
                    </label>
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <!-- Yearly Plans Container -->
          <div data-billing-target="yearlyPlans" class="hidden">
            <!-- Blog Plans Section -->
            <div class="mb-12">
              <h2 class="text-2xl font-semibold text-gray-800 mb-1">Choose your Blog Plan</h2>
              <p class="text-gray-500 mb-6">Based on monthly page views.</p>
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                <% @blog_products.each do |product| %>
                  <div>
                    <%= form.radio_button :blog_price_id, product.yearly_plan.id, id: product.yearly_plan.id, class: "hidden peer", checked: @selected_blog_price == product.yearly_plan.id, data: { plan_price: product.yearly_plan&.unit_amount / 100, plan_name: product.metadata.name, action: "change->billing#recalculate" } %>
                    <label for="<%= product.yearly_plan.id %>" class="inline-block w-full p-6 text-gray-500 bg-white border-2 border-gray-200 rounded-lg cursor-pointer transition-all duration-200 ease-in-out hover:text-gray-600 hover:bg-gray-50 hover:shadow-md peer-checked:border-primary peer-checked:shadow-lg">
                      <span class="font-bold text-lg text-gray-800"><%= product.metadata.name %></span>
                      <span class="text-2xl font-extrabold flex items-end text-gray-900 mt-1">
                      $<%= product.yearly_plan&.unit_amount / 100 / 12 %>
                        <span class="text-base font-medium text-gray-500">/mo</span>
                    </span>
                      <span class="text-xs font-medium text-gray-500">billed annually</span>
                    </label>
                  </div>
                <% end %>
              </div>
            </div>
            <!-- Newsletter Plans Section -->
            <div class="mb-12">
              <h2 class="text-2xl font-semibold text-gray-800 mb-1">Choose your Newsletter Plan</h2>
              <p class="text-gray-500 mb-6">Based on e-mails sent per month.</p>
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                <% @newsletter_products.each do |product| %>
                  <div>
                    <%= form.radio_button :newsletter_price_id, product.yearly_plan.id, id: product.yearly_plan.id, class: "hidden peer", checked: @selected_newsletter_price == product.yearly_plan.id, data: { plan_price: product.yearly_plan&.unit_amount / 100, plan_name: product.metadata.name, action: "change->billing#recalculate" } %>
                    <label for="<%= product.yearly_plan.id %>" class="inline-block w-full p-6 text-gray-500 bg-white border-2 border-gray-200 rounded-lg cursor-pointer transition-all duration-200 ease-in-out hover:text-gray-600 hover:bg-gray-50 hover:shadow-md peer-checked:border-primary peer-checked:shadow-lg">
                      <span class="font-bold text-lg text-gray-800"><%= product.metadata.name %></span>
                      <span class="text-2xl font-extrabold flex items-end text-gray-900 mt-1">
                      $<%= product.yearly_plan&.unit_amount / 100 / 12 %>
                        <span class="text-base font-medium text-gray-500">/mo</span>
                    </span>
                      <span class="text-xs font-medium text-gray-500">billed annually</span>
                    </label>
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <!-- Checkout Section -->
          <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 mt-10">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Your Selection</h3>
            <div id="selection-summary" class="space-y-4 mb-6">
              <div class="flex justify-between items-center">
                <p class="text-gray-600">Blog Plan:</p>
                <p class="font-semibold text-gray-800" data-billing-target="selectedBlogPlan">None selected</p>
              </div>
              <div class="flex justify-between items-center">
                <p class="text-gray-600">Newsletter Plan:</p>
                <p class="font-semibold text-gray-800" data-billing-target="selectedNewsletterPlan">None
                  selected</p>
              </div>
              <div class="border-t border-gray-200 pt-4 mt-4">
                <div class="flex justify-between items-center">
                  <p class="text-lg font-bold text-gray-900">Total:</p>
                  <p class="text-lg font-bold text-gray-900" data-billing-target="totalPrice">$0.00/mo</p>
                </div>
                <p class="text-xs text-gray-500 text-right" data-billing-target="billedInterval"></p>
              </div>
            </div>

            <%= form.submit "Continue to Checkout", class: "w-full btn btn-primary btn-lg", data: { billing_target: "checkoutButton" } %>
            <% if @subscription.present? %>
              <button class="hover:opacity-80 active:opacity-70 underline mx-auto text-gray-500 text-xs mt-5 cursor-pointer" data-action="click->billing#showCurrentPlan:stop:prevent">Back
                to current plan
              </button>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

  </div>

  <% if @workspace.stripe_customer_id.present? %>
    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-gray-200 mt-10">
      <div class="flex flex-col sm:flex-row justify-between items-center">
        <div>
          <h2 class="text-base font-semibold text-gray-900">Manage all your subscriptions</h2>
          <p class="text-gray-500 mt-1 text-sm">Check Stripe dashboard to manage all your subscriptions!</p>
        </div>
        <div class="mt-4 sm:mt-0">
          <%= link_to "Manage Subscriptions", customer_portal_settings_billing_path, class: 'btn btn-outline btn-neutral' %>
        </div>
      </div>
    </div>
  <% end %>
</div>